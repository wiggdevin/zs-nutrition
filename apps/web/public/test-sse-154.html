<!DOCTYPE html>
<html>
<head>
  <title>Feature #154 SSE Test</title>
  <style>
    body { background: #0a0a0a; color: #fafafa; font-family: monospace; padding: 20px; }
    h1 { color: #f97316; }
    .event { background: #1a1a1a; border: 1px solid #2a2a2a; padding: 10px; margin: 10px 0; }
    .success { color: #22c55e; }
    .error { color: #ef4444; }
    button { background: #f97316; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; }
    button:hover { background: #ea580c; }
    input { background: #1a1a1a; border: 1px solid #2a2a2a; color: #fafafa; padding: 5px; }
  </style>
</head>
<body>
  <h1>Feature #154: SSE Stream Test</h1>
  <p>Testing: /api/plan-stream/[jobId]</p>

  <div>
    <label>Job ID: </label>
    <input type="text" id="jobId" value="5c070eec-72b6-423c-a53e-859b52fbb386" style="width: 400px; padding: 5px;">
    <button onclick="testSSE()">Test SSE Stream</button>
  </div>

  <div id="status"></div>
  <div id="events"></div>

  <script>
    function testSSE() {
      const jobId = document.getElementById('jobId').value;
      const statusDiv = document.getElementById('status');
      const eventsDiv = document.getElementById('events');

      statusDiv.innerHTML = '<p style="color: #f59e0b;">Connecting to SSE stream...</p>';
      eventsDiv.innerHTML = '';

      const eventSource = new EventSource(`/api/plan-stream/${jobId}`);
      const events = [];

      eventSource.addEventListener('message', (e) => {
        console.log('SSE message:', e.data);
        try {
          const data = JSON.parse(e.data);
          events.push(data);

          const eventDiv = document.createElement('div');
          eventDiv.className = 'event';
          eventDiv.innerHTML = `
            <strong>Event ${events.length}:</strong><br>
            Status: ${data.status}<br>
            Agent: ${data.agent} - ${data.agentName || 'N/A'}<br>
            Message: ${data.message}<br>
            ${data.planId ? 'Plan ID: ' + data.planId : ''}
          `;
          eventsDiv.appendChild(eventDiv);

          if (data.status === 'completed') {
            statusDiv.innerHTML = '<p class="success">✅ Stream completed successfully!</p>';
            eventSource.close();
            verifyResults(events);
          } else if (data.status === 'failed') {
            statusDiv.innerHTML = '<p class="error">❌ Stream failed: ' + data.message + '</p>';
            eventSource.close();
          }
        } catch (err) {
          console.error('Error parsing SSE data:', err);
        }
      });

      eventSource.addEventListener('error', (e) => {
        console.error('SSE error:', e);
        statusDiv.innerHTML = '<p class="error">❌ SSE connection error</p>';
        eventSource.close();
      });

      setTimeout(() => {
        eventSource.close();
      }, 30000);
    }

    function verifyResults(events) {
      const verificationDiv = document.createElement('div');
      verificationDiv.className = 'event';

      const checks = [
        { name: 'Received events', pass: events.length > 0 },
        { name: 'Agent progress (1-6)', pass: events.some(e => e.agent >= 1 && e.agent <= 6) },
        { name: 'Status field present', pass: events.every(e => e.status) },
        { name: 'Agent number present', pass: events.every(e => e.agent !== undefined) },
        { name: 'Message present', pass: events.every(e => e.message) },
        { name: 'Completed event received', pass: events.some(e => e.status === 'completed') },
        { name: 'Plan ID in completed event', pass: events.some(e => e.status === 'completed' && e.planId) },
      ];

      const allPass = checks.every(c => c.pass);

      verificationDiv.innerHTML = `
        <strong style="color: ${allPass ? '#22c55e' : '#ef4444'}">
          ${allPass ? '✅ ALL VERIFICATION CHECKS PASSED' : '❌ SOME CHECKS FAILED'}
        </strong><br><br>
        ${checks.map(c => `<span style="color: ${c.pass ? '#22c55e' : '#ef4444'}">${c.pass ? '✅' : '❌'}</span> ${c.name}`).join('<br>')}
      `;

      document.getElementById('events').appendChild(verificationDiv);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature #85: Onboarding Cleanup Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #0a0a0a; }
    .test-result { font-family: monospace; }
    .pass { color: #22c55e; }
    .fail { color: #ef4444; }
    .pending { color: #f97316; }
  </style>
</head>
<body class="min-h-screen p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-white mb-2">Feature #85: Onboarding Cleanup Test</h1>
    <p class="text-gray-400 mb-8">Testing that OnboardingState is cleaned up after successful completion</p>

    <div class="space-y-4">
      <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
        <h2 class="text-xl font-bold text-white mb-4">Test Steps</h2>
        <div class="space-y-2">
          <div id="step1" class="test-result pending">Step 1: Complete all 6 onboarding steps - PENDING</div>
          <div id="step2" class="test-result pending">Step 2: Verify UserProfile is created - PENDING</div>
          <div id="step3" class="test-result pending">Step 3: Verify OnboardingState is marked as completed or removed - PENDING</div>
          <div id="step4" class="test-result pending">Step 4: Verify re-visiting /onboarding redirects to dashboard - PENDING</div>
        </div>
      </div>

      <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
        <h2 class="text-xl font-bold text-white mb-4">Test Actions</h2>
        <div class="space-y-4">
          <button onclick="runTest()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded">
            Run Automated Test
          </button>
          <div class="space-y-2">
            <button onclick="checkOnboardingState()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
              Check OnboardingState
            </button>
            <button onclick="checkUserProfile()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
              Check UserProfile
            </button>
            <button onclick="deleteOnboardingState()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
              Delete OnboardingState (Manual Cleanup)
            </button>
            <button onclick="startFreshOnboarding()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
              Start Fresh Onboarding
            </button>
          </div>
        </div>
      </div>

      <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
        <h2 class="text-xl font-bold text-white mb-4">Test Output</h2>
        <pre id="output" class="text-sm text-gray-300 whitespace-pre-wrap bg-gray-950 p-4 rounded max-h-96 overflow-y-auto"></pre>
      </div>

      <div class="bg-gray-900 rounded-lg p-6 border border-gray-800">
        <h2 class="text-xl font-bold text-white mb-4">Database State</h2>
        <pre id="dbState" class="text-sm text-gray-300 whitespace-pre-wrap bg-gray-950 p-4 rounded max-h-96 overflow-y-auto"></pre>
      </div>
    </div>
  </div>

  <script>
    const TEST_USER_ID = 'feature-85-test-user';
    let testResults = {};

    function log(message) {
      const output = document.getElementById('output');
      const timestamp = new Date().toISOString();
      output.textContent += `[${timestamp}] ${message}\n`;
      output.scrollTop = output.scrollHeight;
    }

    function updateStep(stepId, status, message) {
      const step = document.getElementById(stepId);
      step.className = `test-result ${status}`;
      step.textContent = message;
      testResults[stepId] = { status, message };
    }

    async function checkOnboardingState() {
      log('\n=== Checking OnboardingState ===');
      try {
        const response = await fetch('/api/onboarding');
        const data = await response.json();
        log(`OnboardingState: ${JSON.stringify(data, null, 2)}`);
        updateDBStateDisplay();
        return data;
      } catch (error) {
        log(`Error: ${error.message}`);
        return null;
      }
    }

    async function checkUserProfile() {
      log('\n=== Checking UserProfile ===');
      try {
        const response = await fetch('/api/profile');
        if (!response.ok) {
          log(`No profile found (${response.status})`);
          updateDBStateDisplay();
          return null;
        }
        const data = await response.json();
        log(`UserProfile: ${JSON.stringify(data, null, 2)}`);
        updateDBStateDisplay();
        return data;
      } catch (error) {
        log(`Error: ${error.message}`);
        return null;
      }
    }

    async function deleteOnboardingState() {
      log('\n=== Manually Deleting OnboardingState ===');
      try {
        const response = await fetch('/api/dev-delete-onboarding', {
          method: 'DELETE',
        });
        const data = await response.json();
        log(`Result: ${JSON.stringify(data, null, 2)}`);
        updateDBStateDisplay();
      } catch (error) {
        log(`Error: ${error.message}`);
      }
    }

    async function startFreshOnboarding() {
      log('\n=== Starting Fresh Onboarding ===');
      try {
        // First delete any existing onboarding state
        await deleteOnboardingState();

        // Create new onboarding state
        const response = await fetch('/api/onboarding', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            step: 1,
            data: { name: 'Feature 85 Test User' }
          })
        });
        const data = await response.json();
        log(`Created: ${JSON.stringify(data, null, 2)}`);
        updateDBStateDisplay();
      } catch (error) {
        log(`Error: ${error.message}`);
      }
    }

    async function completeOnboarding() {
      log('\n=== Completing Onboarding ===');
      try {
        const profileData = {
          name: 'Feature 85 Test User',
          sex: 'male',
          age: 30,
          heightCm: 180,
          weightKg: 75,
          goalType: 'maintain',
          activityLevel: 'moderately_active',
          dietaryStyle: 'omnivore',
          mealsPerDay: 3,
          snacksPerDay: 1,
          cookingSkill: 5,
          prepTimeMax: 30,
          macroStyle: 'balanced',
        };

        const response = await fetch('/api/onboarding/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ profileData })
        });

        const data = await response.json();
        log(`Completion Result: ${JSON.stringify(data, null, 2)}`);
        return data;
      } catch (error) {
        log(`Error: ${error.message}`);
        return null;
      }
    }

    async function checkRedirect() {
      log('\n=== Checking Redirect Behavior ===');
      try {
        const response = await fetch('/api/onboarding');
        const data = await response.json();

        if (data.completed) {
          log('✓ Onboarding is marked as completed');
          updateStep('step3', 'pass', 'Step 3: Verify OnboardingState is marked as completed or removed - PASS');
          return true;
        } else {
          log('✗ Onboarding is NOT marked as completed');
          updateStep('step3', 'fail', 'Step 3: Verify OnboardingState is marked as completed or removed - FAIL');
          return false;
        }
      } catch (error) {
        log(`Error: ${error.message}`);
        return false;
      }
    }

    async function updateDBStateDisplay() {
      try {
        const [onboardingRes, profileRes] = await Promise.all([
          fetch('/api/onboarding'),
          fetch('/api/profile').catch(() => ({ ok: false }))
        ]);

        let state = '';

        if (onboardingRes.ok) {
          const onboarding = await onboardingRes.json();
          state += `OnboardingState:\n${JSON.stringify(onboarding, null, 2)}\n\n`;
        } else {
          state += `OnboardingState: NOT FOUND (cleaned up)\n\n`;
        }

        if (profileRes.ok) {
          const profile = await profileRes.json();
          state += `UserProfile:\n${JSON.stringify(profile, null, 2)}\n\n`;
        } else {
          state += `UserProfile: NOT FOUND\n\n`;
        }

        document.getElementById('dbState').textContent = state;
      } catch (error) {
        document.getElementById('dbState').textContent = `Error: ${error.message}`;
      }
    }

    async function runTest() {
      log('\n=== Starting Feature #85 Test ===\n');
      document.getElementById('output').textContent = '';

      // Reset test results
      testResults = {};
      ['step1', 'step2', 'step3', 'step4'].forEach(id => {
        updateStep(id, 'pending', `${id.replace('step', 'Step ')} - PENDING`);
      });

      // Step 1: Complete onboarding
      updateStep('step1', 'pending', 'Step 1: Complete all 6 onboarding steps - TESTING...');
      const completionResult = await completeOnboarding();
      if (completionResult && completionResult.success) {
        updateStep('step1', 'pass', 'Step 1: Complete all 6 onboarding steps - PASS');
        log('✓ Step 1: Onboarding completed successfully');
      } else {
        updateStep('step1', 'fail', 'Step 1: Complete all 6 onboarding steps - FAIL');
        log('✗ Step 1: Failed to complete onboarding');
        return;
      }

      // Wait for database to update
      await new Promise(resolve => setTimeout(resolve, 1000));
      await updateDBStateDisplay();

      // Step 2: Verify UserProfile is created
      updateStep('step2', 'pending', 'Step 2: Verify UserProfile is created - TESTING...');
      const profile = await checkUserProfile();
      if (profile && profile.id) {
        updateStep('step2', 'pass', 'Step 2: Verify UserProfile is created - PASS');
        log('✓ Step 2: UserProfile exists');
      } else {
        updateStep('step2', 'fail', 'Step 2: Verify UserProfile is created - FAIL');
        log('✗ Step 2: UserProfile not found');
        return;
      }

      // Step 3: Verify OnboardingState is cleaned up
      updateStep('step3', 'pending', 'Step 3: Verify OnboardingState is marked as completed or removed - TESTING...');
      await new Promise(resolve => setTimeout(resolve, 500));
      const onboardingState = await checkOnboardingState();

      if (onboardingState && onboardingState.completed) {
        // OnboardingState exists but is marked as completed
        // This means it was NOT cleaned up - this is the OLD behavior
        updateStep('step3', 'fail', 'Step 3: Verify OnboardingState is marked as completed or removed - FAIL (state not deleted)');
        log('✗ Step 3: OnboardingState still exists (should be cleaned up)');
      } else if (onboardingState && !onboardingState.completed) {
        // OnboardingState exists but not completed
        updateStep('step3', 'fail', 'Step 3: Verify OnboardingState is marked as completed or removed - FAIL (not completed)');
        log('✗ Step 3: OnboardingState not completed');
      } else {
        // OnboardingState was not found or has no data - means it was cleaned up
        updateStep('step3', 'pass', 'Step 3: Verify OnboardingState is marked as completed or removed - PASS (cleaned up)');
        log('✓ Step 3: OnboardingState was cleaned up (deleted)');
      }

      // Step 4: Verify redirect behavior
      updateStep('step4', 'pending', 'Step 4: Verify re-visiting /onboarding redirects to dashboard - TESTING...');

      // The OnboardingWizard component should check for completed onboarding
      // and redirect to /dashboard instead of /generate
      if (onboardingState && onboardingState.completed) {
        updateStep('step4', 'pass', 'Step 4: Verify re-visiting /onboarding redirects to dashboard - PASS (will redirect)');
        log('✓ Step 4: OnboardingWizard will redirect to /dashboard');
      } else if (!onboardingState || onboardingState.completed) {
        // OnboardingState was cleaned up - the API returns completed=true when no state exists but profile exists
        updateStep('step4', 'pass', 'Step 4: Verify re-visiting /onboarding redirects to dashboard - PASS (will redirect)');
        log('✓ Step 4: OnboardingWizard will redirect to /dashboard');
      } else {
        updateStep('step4', 'fail', 'Step 4: Verify re-visiting /onboarding redirects to dashboard - FAIL');
        log('✗ Step 4: Will not redirect');
      }

      // Final summary
      log('\n=== Test Summary ===');
      const passCount = Object.values(testResults).filter(r => r.status === 'pass').length;
      const totalCount = Object.keys(testResults).length;
      log(`Results: ${passCount}/${totalCount} steps passed`);

      if (passCount === totalCount) {
        log('\n✓✓✓ ALL TESTS PASSED ✓✓✓');
      } else {
        log('\n✗✗✗ SOME TESTS FAILED ✗✗✗');
      }
    }

    // Initialize display
    updateDBStateDisplay();
    log('Test page loaded. Click "Run Automated Test" to begin.');
  </script>
</body>
</html>

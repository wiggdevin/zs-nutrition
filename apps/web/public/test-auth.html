<!DOCTYPE html>
<html>
<head>
  <title>Auth Test - Feature 160</title>
</head>
<body>
  <h1>Setting up authentication for confetti test...</h1>
  <p id="status">Step 1: Creating user...</p>

  <script>
    const testEmail = 'confetti-test-160@zsmac.dev';

    // Step 1: Create user
    fetch('/api/dev-auth/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: testEmail,
        name: 'Confetti Test 160',
        sex: 'male',
        age: 30,
        heightFt: 5,
        heightIn: 10,
        weightLbs: 180,
        goalType: 'maintain',
        goalRate: 0.5,
        dietaryStyle: 'balanced',
        activityLevel: 'moderate',
        cookingSkill: 'intermediate',
        prepTimeMax: 30,
        macroStyle: 'balanced',
        mealsPerDay: 3,
        snacksPerDay: 2,
        trainingDays: [1, 3, 5]
      })
    })
    .then(res => res.json())
    .then(signupData => {
      document.getElementById('status').textContent = 'Step 2: Signing in...';
      console.log('Signup:', signupData);

      // Step 2: Sign in (server will create profile and onboarding)
      return fetch('/api/dev-auth/signin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: testEmail })
      });
    })
    .then(res => res.json())
    .then(signinData => {
      document.getElementById('status').textContent = 'Step 3: Setting localStorage and redirecting...';
      console.log('Signin:', signinData);

      if (signinData.success) {
        // Set localStorage for client-side checks
        localStorage.setItem('zsn_user_profile', JSON.stringify({
          name: 'Confetti Test 160',
          sex: 'male',
          age: 30,
          heightFt: 5,
          heightIn: 10,
          weightLbs: 180
        }));
        localStorage.setItem('zsn_onboarding_complete', 'true');

        // Redirect to generate page
        setTimeout(() => {
          window.location.href = '/generate';
        }, 500);
      } else {
        document.getElementById('status').textContent = 'Error: ' + JSON.stringify(signinData);
      }
    })
    .catch(err => {
      document.getElementById('status').textContent = 'Error: ' + err.message;
      console.error('Error:', err);
    });
  </script>
</body>
</html>

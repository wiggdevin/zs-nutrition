// Zero Sum Nutrition - Prisma Schema
// Database: PostgreSQL (Neon)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// User (synced with Clerk)
// ============================================================
model User {
  id            String    @id @default(uuid())
  clerkUserId   String    @unique
  email         String    @unique
  isActive      Boolean   @default(true)
  deactivatedAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  profiles           UserProfile[]
  mealPlans          MealPlan[]
  dailyLogs          DailyLog[]
  trackedMeals       TrackedMeal[]
  foodScans          FoodScan[]
  onboarding         OnboardingState?
  planGenerationJobs PlanGenerationJob[]
  weightEntries      WeightEntry[]
  calorieAdjustments CalorieAdjustment[]
  fitnessConnections FitnessConnection[]
  activitySyncs      ActivitySync[]
  waterLogs          WaterLog[]
}

// ============================================================
// Onboarding State (resumable wizard)
// ============================================================
model OnboardingState {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentStep Int      @default(1)
  completed   Boolean  @default(false)
  stepData    Json? // Partial RawIntakeForm - defaults handled at app level
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================================
// User Profile (demographics, goals, preferences, cached metabolic)
// ============================================================
model UserProfile {
  id             String  @id @default(uuid())
  userId         String
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name           String
  sex            String // male | female
  age            Int
  heightCm       Float
  weightKg       Float
  bodyFatPercent Float?
  goalType       String // cut | maintain | bulk
  goalRate       Float // 0-2 lbs/week
  activityLevel  String // sedentary | lightly_active | moderately_active | very_active | extremely_active
  dietaryStyle   String // omnivore | vegetarian | vegan | pescatarian | keto | paleo
  allergies      Json? // Array of allergy strings - defaults handled at app level
  exclusions     Json? // Array of exclusion strings - defaults handled at app level
  cuisinePrefs   Json? // Array of cuisine preference strings - defaults handled at app level
  trainingDays   Json? // Array of weekdays - defaults handled at app level
  trainingTime   String? // morning | afternoon | evening
  mealsPerDay    Int     @default(3)
  snacksPerDay   Int     @default(1)
  cookingSkill   Int     @default(5)
  prepTimeMax    Int     @default(30)
  macroStyle     String  @default("balanced")

  // Cached metabolic calculations
  bmrKcal        Int?
  tdeeKcal       Int?
  goalKcal       Int?
  proteinTargetG Int?
  carbsTargetG   Int?
  fatTargetG     Int?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mealPlans MealPlan[]

  @@index([userId, isActive])
}

// ============================================================
// Meal Plan
// ============================================================
model MealPlan {
  id                String      @id @default(uuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  profileId         String
  profile           UserProfile @relation(fields: [profileId], references: [id])
  validatedPlan     Json? // Full MealPlanValidated - defaults handled at app level
  metabolicProfile  Json? // MetabolicProfile - defaults handled at app level
  draftData         Json? // MealPlanDraft (Agent 3 output) for fast-path recalculation
  dailyKcalTarget   Int?
  dailyProteinG     Int?
  dailyCarbsG       Int?
  dailyFatG         Int?
  trainingBonusKcal Int?
  planDays          Int         @default(7)
  startDate         DateTime?
  endDate           DateTime?
  qaScore           Int? // 0-100
  qaStatus          String? // PASS | WARN | FAIL
  pdfUrl            String?
  version           Int         @default(1)
  status            String      @default("active") // active | expired | replaced | deleted
  isActive          Boolean     @default(true)
  deletedAt         DateTime? // Soft delete timestamp - null means not deleted
  generatedAt       DateTime    @default(now())
  versionedAt       DateTime?   @default(now())

  swaps        MealSwap[]
  trackedMeals TrackedMeal[]

  @@index([userId, isActive])
  @@index([userId, status, isActive])
  @@index([userId, isActive, deletedAt])
  @@index([generatedAt])
}

// ============================================================
// Meal Swap History
// ============================================================
model MealSwap {
  id           String   @id @default(uuid())
  mealPlanId   String
  mealPlan     MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  dayNumber    Int
  slot         String
  originalMeal Json // Original meal data - required field
  newMeal      Json // New meal data - required field
  createdAt    DateTime @default(now())

  @@index([mealPlanId, dayNumber, slot])
}

// ============================================================
// Plan Generation Job (BullMQ tracking)
// ============================================================
model PlanGenerationJob {
  id           String    @id @default(uuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  status       String    @default("pending") // pending | running | completed | failed
  currentAgent Int?
  progress     Json? // Progress tracking data
  intakeData   Json // RawIntakeForm - required field
  result       Json? // Pipeline result on success
  error        String?
  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime  @default(now())

  @@index([userId, status])
  @@index([createdAt])
}

// ============================================================
// Daily Log (one per user per date)
// ============================================================
model DailyLog {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date           DateTime // date field
  targetKcal     Int?
  targetProteinG Int?
  targetCarbsG   Int?
  targetFatG     Int?
  actualKcal     Int      @default(0)
  actualProteinG Int      @default(0)
  actualCarbsG   Int      @default(0)
  actualFatG     Int      @default(0)
  adherenceScore Int? // 0-100
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId, date])
}

// ============================================================
// Tracked Meal (individual meal log entries)
// ============================================================
model TrackedMeal {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  mealPlanId      String?
  mealPlan        MealPlan? @relation(fields: [mealPlanId], references: [id])
  loggedDate      DateTime // date field
  mealSlot        String?
  mealName        String
  portion         Float     @default(1.0)
  kcal            Int
  proteinG        Float
  carbsG          Float
  fatG            Float
  fiberG          Float?
  source          String // plan_meal | fatsecret_search | manual | quick_add | food_scan
  confidenceScore Float? // 0-1
  fatsecretId     String?
  photoUrl        String?
  scanId          String?
  createdAt       DateTime  @default(now())

  // Prevent duplicate plan meal entries: same user, plan, slot, date, source
  // This is the database-level guard against race conditions where two identical
  // requests pass the application-level duplicate check simultaneously.
  // NOTE: A migration is needed after this change (npx prisma migrate dev)
  @@unique([userId, mealPlanId, loggedDate, mealSlot, source], name: "TrackedMeal_plan_dedup")
  @@index([userId, loggedDate])
  @@index([loggedDate])
  @@index([source])
}

// ============================================================
// Food Scan (Claude Vision - Phase 2)
// ============================================================
model FoodScan {
  id             String    @id @default(uuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  scanType       String // food_plate | restaurant_menu
  photoUrl       String
  status         String    @default("pending") // pending | processing | completed | failed
  analysisResult Json? // Vision analysis result
  adjustedResult Json? // User-adjusted result
  userConfirmed  Boolean   @default(false)
  error          String?
  createdAt      DateTime  @default(now())
  completedAt    DateTime?

  @@index([userId])
  @@index([status])
}

// ============================================================
// Weight Entry (weekly weight logging for adaptive adjustments)
// ============================================================
model WeightEntry {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  weightKg  Float // weight in kg
  weightLbs Float // weight in lbs (calculated for display)
  logDate   DateTime // date of the entry
  notes     String? // optional notes about the entry
  createdAt DateTime @default(now())

  @@unique([userId, logDate])
  @@index([userId, logDate])
}

// ============================================================
// Calorie Adjustment (adaptive calorie target changes with audit log)
// ============================================================
model CalorieAdjustment {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  previousGoalKcal  Int // previous calorie target
  newGoalKcal       Int // new calorie target
  adjustmentReason  Json // Detailed reasoning for the adjustment - required field
  weightChangeKg    Float? // weight change that triggered adjustment
  weightChangeLbs   Float? // weight change in lbs for display
  trendAnalysis     Json? // Trend data that led to adjustment
  milestoneAchieved String? // milestone reached (e.g., "5lbs", "10lbs")
  planRegenerated   Boolean  @default(false) // whether meal plan was regenerated
  createdAt         DateTime @default(now())

  @@index([userId, createdAt])
}

// ============================================================
// Fitness Connection (OAuth tokens for fitness platforms)
// ============================================================
model FitnessConnection {
  id             String    @id @default(uuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  platform       String // apple_health | google_fit | fitbit | oura
  accessToken    String // encrypted OAuth access token
  refreshToken   String? // encrypted OAuth refresh token (if available)
  tokenExpiresAt DateTime? // token expiration timestamp
  platformUserId String? // external user ID from the platform
  scope          String? // granted permissions scope
  isActive       Boolean   @default(true)
  lastSyncAt     DateTime? // last successful sync timestamp
  syncFrequency  String    @default("daily") // hourly | daily | weekly
  settings       Json? // User preferences for this connection - defaults handled at app level
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  activitySyncs ActivitySync[]

  @@unique([userId, platform])
  @@index([userId, platform, isActive])
  @@index([lastSyncAt])
}

// ============================================================
// Activity Sync (normalized activity data from fitness platforms)
// ============================================================
model ActivitySync {
  id             String            @id @default(uuid())
  userId         String
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  connectionId   String
  connection     FitnessConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  platform       String // apple_health | google_fit | fitbit | oura
  syncDate       DateTime // date of the activity data (not sync time)
  steps          Int?
  activeCalories Float? // calories burned from activity
  totalCalories  Float? // total daily calories (BMR + active)
  distanceKm     Float?
  distanceMiles  Float?
  activeMinutes  Int? // minutes of moderate+ activity
  workoutCount   Int?
  workouts       Json? // Array of workout details - defaults handled at app level
  sleepMinutes   Int? // from Oura primarily
  sleepScore     Int? // 0-100 sleep quality score
  heartRateAvg   Float?
  heartRateMax   Int?
  rawSyncData    Json? // Full platform response for debugging - defaults handled at app level
  syncedAt       DateTime          @default(now())
  processed      Boolean           @default(false) // whether calorie adjustment was applied

  @@unique([connectionId, syncDate])
  @@index([userId, syncDate])
  @@index([connectionId, syncDate])
  @@index([processed])
}

// ============================================================
// Water Log (daily water intake tracking)
// ============================================================
model WaterLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date      DateTime
  amountMl  Int
  source    String   @default("manual") // manual | quick_add
  createdAt DateTime @default(now())

  @@index([userId, date])
}

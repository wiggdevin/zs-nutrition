name: Staging Deploy

on:
  push:
    branches: [staging]
  workflow_dispatch:

concurrency:
  group: staging-deploy
  cancel-in-progress: true

jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - name: Security Audit
        run: pnpm audit --audit-level=high
        continue-on-error: true

      - name: Type Check
        run: pnpm turbo typecheck

      - name: Lint
        run: pnpm turbo lint

      - name: Test
        run: pnpm turbo test
        continue-on-error: true

      - name: Build
        run: pnpm turbo build
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          CLERK_SECRET_KEY: ${{ secrets.STAGING_CLERK_SECRET_KEY }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.STAGING_NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.STAGING_ANTHROPIC_API_KEY }}
          REDIS_URL: ${{ secrets.STAGING_REDIS_URL }}
          FATSECRET_CLIENT_ID: ${{ secrets.STAGING_FATSECRET_CLIENT_ID }}
          FATSECRET_CLIENT_SECRET: ${{ secrets.STAGING_FATSECRET_CLIENT_SECRET }}
          USDA_API_KEY: ${{ secrets.STAGING_USDA_API_KEY }}
          SKIP_ENV_VALIDATION: 'true'

  migrate:
    name: Database Migration
    runs-on: ubuntu-latest
    needs: quality

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - name: Run Prisma Migrations
        run: npx prisma migrate deploy --schema=apps/web/prisma/schema.prisma
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}

  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: migrate

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Vercel Staging
        id: vercel-deploy
        run: |
          DEPLOY_OUTPUT=$(npx vercel deploy --target=staging --token=${{ secrets.VERCEL_TOKEN }} --yes 2>&1)
          DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep -oP 'https://[^\s]+\.vercel\.app' | tail -1)
          if [ -z "$DEPLOY_URL" ]; then
            DEPLOY_URL="${{ secrets.STAGING_URL }}"
          fi
          echo "deploy_url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"
          echo "Deployed to: $DEPLOY_URL"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    outputs:
      deploy_url: ${{ steps.vercel-deploy.outputs.deploy_url }}

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 30

      - name: Check staging health
        run: |
          STAGING_URL="${{ needs.deploy.outputs.deploy_url }}"
          if [ -z "$STAGING_URL" ]; then
            STAGING_URL="${{ secrets.STAGING_URL }}"
          fi

          echo "Checking health at: $STAGING_URL/api/health"

          MAX_RETRIES=5
          RETRY_DELAY=10

          for i in $(seq 1 $MAX_RETRIES); do
            RESPONSE=$(curl -sf "$STAGING_URL/api/health" 2>&1) && {
              echo "Health check response: $RESPONSE"
              STATUS=$(echo "$RESPONSE" | jq -r '.status' 2>/dev/null)
              if [ "$STATUS" = "ok" ] || [ "$STATUS" = "degraded" ]; then
                echo "Staging is healthy (status: $STATUS)"
                exit 0
              else
                echo "Unexpected status: $STATUS"
              fi
            } || {
              echo "Attempt $i/$MAX_RETRIES failed, retrying in ${RETRY_DELAY}s..."
            }
            sleep $RETRY_DELAY
          done

          echo "Health check failed after $MAX_RETRIES attempts"
          exit 1

  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy, health-check]

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        run: npx playwright install chromium --with-deps

      - name: Run Smoke Tests
        run: npx playwright test --config=playwright.staging.config.ts
        env:
          STAGING_URL: ${{ needs.deploy.outputs.deploy_url }}
